# quicd Configuration Reference
#
# This file documents all available configuration options for the quicd QUIC server.
# All fields are optional and have sensible defaults.
#
# Configuration Hierarchy:
# 1. Default values (lowest priority)
# 2. This configuration file
# 3. Environment variables (QUICD_ prefix, e.g., QUICD_GLOBAL__NETWORK__HOST)
# 4. Command-line arguments (highest priority)
#
# Validation:
#   quicd --config quicd.toml --validate
#
# Print defaults:
#   quicd --print-default-config

# ============================================================================
# GLOBAL CONFIGURATION
# ============================================================================
# Settings that apply server-wide, independent of application protocols.

[global]

# ----------------------------------------------------------------------------
# Network Binding
# ----------------------------------------------------------------------------
[global.network]
# Host address to bind to
# Examples: "0.0.0.0" (all IPv4), "::" (all IPv6), "127.0.0.1" (localhost)
# Default: "0.0.0.0"
host = "0.0.0.0"

# UDP port to bind to
# Standard: 443 (requires privileges), 8443 (common alternative)
# Default: 443
port = 443

# Enable SO_REUSEADDR socket option
# Allows quick restarts by reusing recently-closed ports
# Default: true
reuse_addr = true

# ----------------------------------------------------------------------------
# TLS / Cryptographic Settings
# ----------------------------------------------------------------------------
[global.tls]
# Path to TLS certificate file (.crt file with PEM encoding)
# Default: None (REQUIRED - must be provided)
cert_path = "/server-cert/cert.crt"

# Path to TLS private key file (.key file with PEM encoding)
# Required if cert_path is specified
# Default: None (REQUIRED - must be provided)
key_path = "/server-cert/key.key"

# Enable TLS 1.3 early data (0-RTT)
# WARNING: 0-RTT data is not forward secret and can be replayed
# Only enable for idempotent applications
# Default: false
enable_early_data = false

# ----------------------------------------------------------------------------
# Runtime Configuration
# ----------------------------------------------------------------------------
[global.runtime]
# Number of Tokio worker threads for async application tasks
# Default: Number of CPU cores
# worker_threads = 8

# Maximum blocking threads in the pool
# Default: 512
max_blocking_threads = 512

# Thread name prefix (for debugging/profiling)
# Default: "quicd-worker"
thread_name = "quicd-worker"

# Stack size per thread in bytes
# Default: 2097152 (2 MB)
thread_stack_size = 2097152

# Enable thread-local statistics collection
# Default: false
enable_thread_stats = false

# ----------------------------------------------------------------------------
# Logging Configuration
# ----------------------------------------------------------------------------
[global.logging]
# Log level: "trace", "debug", "info", "warn", "error"
# Default: "info"
level = "info"

# Enable structured JSON logging (for machine parsing)
# Default: false
json_format = false

# Enable ANSI color codes in logs
# Disable when logging to files or non-TTY outputs
# Default: true
enable_colors = true

# Include source file and line number in logs
# Has performance overhead
# Default: false
include_file_line = false

# ----------------------------------------------------------------------------
# QUIC Transport Configuration
# ----------------------------------------------------------------------------
[global.quic]
# Maximum idle timeout in milliseconds
# Connections idle longer than this are closed
# Default: 30000
max_idle_timeout_ms = 30000

# Initial RTT estimate in milliseconds
# Default: 100
initial_rtt_ms = 100

# Maximum concurrent bidirectional streams per connection
# Default: 100
max_streams_bidi = 100

# Maximum concurrent unidirectional streams per connection
# Default: 100
max_streams_uni = 100

# Maximum UDP payload size in bytes
# Should be ≤ path MTU to avoid fragmentation
# QUIC minimum: 1200 bytes
# Default: 1350
max_udp_payload_size = 1350

# Connection-level receive window (bytes)
# Default: 10485760 (10 MB)
recv_window = 10485760

# Per-stream receive window (bytes)
# Default: 1048576 (1 MB)
stream_recv_window = 1048576

# Disable active migration (prevents IP/port changes)
# Default: false
disable_active_migration = false

# Enable DATAGRAM extension (RFC 9221)
# Default: false
enable_dgram = false

# Maximum DATAGRAM frame size
# Default: 1350
max_dgram_size = 1350

# Enable packet pacing
# Default: true
enable_pacing = true

# Maximum pacing rate in bytes per second (0 = unlimited)
# Default: 0
max_pacing_rate = 0

# ----------------------------------------------------------------------------
# Network I/O Configuration
# ----------------------------------------------------------------------------
[global.netio]
# Number of network I/O worker threads
# Default: Number of CPU cores
workers = 8

# Enable SO_REUSEPORT for load distribution
# Default: true
reuse_port = true

# Pin worker threads to specific CPU cores
# Default: true
pin_to_cpu = true

# io_uring submission queue entries per worker (must be power of 2)
# Default: 2048
uring_entries = 2048

# Kernel receive buffer size (SO_RCVBUF)
# Larger buffers reduce packet loss under burst traffic
# Default: None (system default)
# socket_recv_buffer_size = 2097152  # 2 MB

# Kernel send buffer size (SO_SNDBUF)
# Default: None (system default)
# socket_send_buffer_size = 2097152  # 2 MB

# Enable UDP GRO (Generic Receive Offload)
# Linux 5.0+ only, gracefully degrades on other platforms
# Default: true
enable_gro = true

# Enable UDP GSO (Generic Segmentation Offload)
# Linux 4.18+ only, gracefully degrades on other platforms
# Default: true
enable_gso = true

# Maximum size for coalesced UDP packets
# Default: 1400
max_coalesced_size = 1400

[global.netio.buffer_pool]
# Maximum buffers per worker (isolated pools, no sharing)
# Default: System-calculated
max_buffers_per_worker = 2048

# Datagram size for buffer trimming
# Default: 1350
datagram_size = 1350

# ----------------------------------------------------------------------------
# Channel Capacity Configuration
# ----------------------------------------------------------------------------
[global.channels]
# Worker egress channel capacity (app → worker)
# All app tasks share this channel per worker
# Default: 2048
worker_egress_capacity = 2048

# Connection ingress channel capacity (worker → app)
# Per-connection event stream buffer
# Default: 1024
connection_ingress_capacity = 1024

# Stream ingress channel capacity (worker → app)
# Per-stream data buffer
# Default: 256
stream_ingress_capacity = 256

# Stream egress channel capacity (app → worker)
# Per-stream write command buffer
# Default: 256
stream_egress_capacity = 256

# ----------------------------------------------------------------------------
# Telemetry Configuration
# ----------------------------------------------------------------------------
[global.telemetry]
# Enable telemetry system
# Default: true
enabled = true

# Metrics export interval in seconds
# Default: 60
export_interval_seconds = 60

# OpenTelemetry collector endpoint
# Default: "http://localhost:4317"
otlp_endpoint = "http://localhost:4317"

# Service name for telemetry
# Default: "quicd"
service_name = "quicd"

# Enable detailed per-connection metrics
# Warning: High cardinality, may impact performance
# Default: false
enable_per_connection_metrics = false

# ============================================================================
# APPLICATION CONFIGURATIONS
# ============================================================================
# Define application protocols and their ALPN mappings.
# Each application is defined as a named table under [applications.<name>].
# This ensures no key collisions between applications.
#
# Structure:
# - 'type': distinguishes built-in ("builtin:<name>") from plugins ("plugin")
# - 'alpn': array of ALPN identifiers (one app can handle multiple ALPNs)
# - 'enabled': controls if the application is active (default: true)
# - 'config': subsection for type-specific configuration

# ----------------------------------------------------------------------------
# HTTP/3 Application
# ----------------------------------------------------------------------------
[applications.http3]
type = "builtin:http3"
alpn = ["h3", "h3-29"]  # Handles both standard h3 and draft-29
enabled = true

# QPACK Configuration (RFC 9204)
[applications.http3.config.qpack]
# Maximum dynamic table capacity in bytes
# Default: 4096
max_table_capacity = 4096

# Maximum number of blocked streams waiting for QPACK updates
# Default: 100
blocked_streams = 100

# Server Push Configuration
[applications.http3.config.push]
# Enable HTTP/3 server push
# Default: false
enabled = false

# Maximum concurrent push streams
# Default: 100
max_concurrent = 100

# HTTP Handler Configuration
[applications.http3.config.handler]
# Enable file serving
# Default: true
file_serving_enabled = true

# File serving root directory
# Default: "./www"
file_root = "./www"

# Enable directory listing (security consideration)
# Default: false
directory_listing = false

# Enable compression (gzip, brotli)
# Default: true
compression_enabled = true

# Compression algorithms to use
# Default: ["gzip", "br"]
compression_algorithms = ["gzip", "br"]

# Index file names
# Default: ["index.html", "index.htm"]
index_files = ["index.html", "index.htm"]

# Connection Limits
[applications.http3.config.limits]
# Maximum field section (header) size in bytes
# Default: 16384 (16 KB)
max_field_section_size = 16384

# Maximum concurrent bidirectional streams per connection
# Default: 100
max_concurrent_streams = 100

# Connection idle timeout in seconds
# Default: 30
idle_timeout_secs = 30

# ----------------------------------------------------------------------------
# MOQ (Media over QUIC) Application (Example - Not Implemented Yet)
# ----------------------------------------------------------------------------
# [applications.moq]
# type = "builtin:moq"
# alpn = ["moq"]
# enabled = true
#
# [applications.moq.config]
# # MOQ-specific settings
# max_streams = 50
# track_sources = true

# ----------------------------------------------------------------------------
# Plugin Protocol Example
# ----------------------------------------------------------------------------
# Load a custom protocol from a dynamic library (.so/.dylib/.dll)
# The plugin must be compiled with quicd-x and export the factory using
# the export_quic_app! macro.
#
# [applications.echo]
# type = "plugin"
# alpn = ["echo"]
# enabled = true
#
# [applications.echo.config.plugin]
# # Required: Path to the dynamic library
# library_path = "/usr/local/lib/quicd/libecho_protocol.so"
#
# # Optional: Additional config passed directly to the plugin
# [applications.echo.config.custom]
# buffer_size = 8192
# log_level = "debug"
#
# # Another plugin example with multiple ALPNs
# [applications.custom-media]
# type = "plugin"
# alpn = ["my-media-v1", "my-media-v2"]
# enabled = true
#
# [applications.custom-media.config.plugin]
# library_path = "/path/to/libcustom_media.so"
#
# [applications.custom-media.config.media]
# max_bitrate = 5000
# supported_codecs = ["h264", "vp9"]
#
# ABI Compatibility Requirements:
# - Plugin must be compiled with the same Rust compiler version as the server
# - Plugin must use the same quicd-x dependency version
# - Plugin must be compiled for the same target architecture

# ============================================================================
# CONFIGURATION PRESETS
# ============================================================================
#
# Instead of manually configuring every field, you can use presets:
#
# High Throughput (large buffers, high concurrency):
#   - max_concurrent_streams = 1000
#   - stream_buffer_max_size = 8 MB
#   - worker_egress_capacity = 8192
#
# Low Memory (minimal buffers, tight limits):
#   - max_concurrent_streams = 10
#   - stream_buffer_max_size = 64 KB
#   - worker_egress_capacity = 512
#
# Low Latency (small buffers, aggressive backpressure):
#   - stream_buffer_max_size = 256 KB
#   - idle_check_interval = 1s
#
# CDN/Edge (balanced, with server push):
#   - max_concurrent_streams = 200
#   - enable_server_push = true
#   - qpack_max_table_capacity = 8 KB
#
# Apply presets by starting with a template or manually adjusting values.
