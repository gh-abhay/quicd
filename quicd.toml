# quicd Configuration Reference
#
# This file documents all available configuration options for the quicd QUIC server.
# All fields are optional and have sensible defaults.
#
# Configuration Hierarchy:
# 1. Default values (lowest priority)
# 2. This configuration file
# 3. Environment variables (QUICD_ prefix, e.g., QUICD_GLOBAL__NETWORK__HOST)
# 4. Command-line arguments (highest priority)
#
# Validation:
#   quicd --config quicd.toml --validate
#
# Print defaults:
#   quicd --print-default-config

# ============================================================================
# GLOBAL CONFIGURATION
# ============================================================================
# Settings that apply server-wide, independent of application protocols.

[global]

# ----------------------------------------------------------------------------
# Network Binding
# ----------------------------------------------------------------------------
[global.network]
# Host address to bind to
# Examples: "0.0.0.0" (all IPv4), "::" (all IPv6), "127.0.0.1" (localhost)
# Default: "0.0.0.0"
host = "0.0.0.0"

# UDP port to bind to
# Standard: 443 (requires privileges), 8443 (common alternative)
# Default: 443
port = 443

# Enable SO_REUSEADDR socket option
# Allows quick restarts by reusing recently-closed ports
# Default: true
reuse_addr = true

# ----------------------------------------------------------------------------
# TLS / Cryptographic Settings
# ----------------------------------------------------------------------------
[global.tls]
# Path to TLS certificate file (.crt file with PEM encoding)
# Default: None (REQUIRED - must be provided)
# cert_path = "certs/cert.crt"

# Path to TLS private key file (.key file with PEM encoding)
# Required if cert_path is specified
# Default: None (REQUIRED - must be provided)
# key_path = "certs/key.key"

# Enable TLS 1.3 early data (0-RTT)
# WARNING: 0-RTT data is not forward secret and can be replayed
# Only enable for idempotent applications
# Default: false
enable_early_data = false

# ----------------------------------------------------------------------------
# Runtime Configuration
# ----------------------------------------------------------------------------
[global.runtime]
# Number of Tokio worker threads for async application tasks
# Default: Number of CPU cores
# worker_threads = 8

# Maximum blocking threads in the pool
# Default: 512
max_blocking_threads = 512

# Thread name prefix (for debugging/profiling)
# Default: "quicd-worker"
thread_name = "quicd-worker"

# Stack size per thread in bytes
# Default: 2097152 (2 MB)
thread_stack_size = 2097152

# Enable thread-local statistics collection
# Default: false
enable_thread_stats = false

# ----------------------------------------------------------------------------
# Logging Configuration
# ----------------------------------------------------------------------------
[global.logging]
# Log level: "trace", "debug", "info", "warn", "error"
# Default: "info"
level = "info"

# Enable structured JSON logging (for machine parsing)
# Default: false
json_format = false

# Enable ANSI color codes in logs
# Disable when logging to files or non-TTY outputs
# Default: true
enable_colors = true

# Include source file and line number in logs
# Has performance overhead
# Default: false
include_file_line = false

# ----------------------------------------------------------------------------
# QUIC Transport Configuration
# ----------------------------------------------------------------------------
[global.quic]
# Maximum idle timeout in milliseconds
# Connections idle longer than this are closed
# Default: System-optimized (typically 30000)
# max_idle_timeout_ms = 30000

# Initial RTT estimate in milliseconds
# Default: 100
initial_rtt_ms = 100

# Maximum concurrent bidirectional streams per connection
# Default: 100
max_streams_bidi = 100

# Maximum concurrent unidirectional streams per connection
# Default: 100
max_streams_uni = 100

# Maximum UDP payload size in bytes
# Should be ≤ path MTU to avoid fragmentation
# QUIC minimum: 1200 bytes
# Default: System-optimized (typically 1350)
# max_udp_payload_size = 1350

# Connection-level receive window (bytes)
# Default: System-optimized (typically 10485760 = 10 MB)
# recv_window = 10485760

# Per-stream receive window (bytes)
# Default: System-optimized (typically 1048576 = 1 MB)
# stream_recv_window = 1048576

# Congestion control algorithm
# Options: "cubic", "bbr", "bbr2", "reno"
# Default: "cubic"
congestion_control = "cubic"

# Enable early data (0-RTT) at QUIC layer
# Default: false
enable_early_data = false

# Disable active migration (prevents IP/port changes)
# Default: false
disable_active_migration = false

# Enable packet pacing
# Default: true
enable_pacing = true

# Maximum connections per worker thread
# Default: System-calculated (typically 100000)
# max_connections_per_worker = 100000

# Enable QUIC version negotiation
# Default: true
enable_version_negotiation = true

# Additional QUIC versions to support (v1 always enabled)
# Default: []
# additional_versions = ["draft-29"]

# Enable DATAGRAM extension (RFC 9221)
# Default: false
enable_dgram = false

# Maximum DATAGRAM frame size
# Default: System-optimized (typically 1350)
# max_dgram_size = 1350

# Enable connection statistics collection
# Default: true
enable_stats = true

# ACK delay exponent (RFC 9000 §13.2.1)
# Default: 3
ack_delay_exponent = 3

# Maximum ACK delay in milliseconds (RFC 9000 §13.2.1)
# Default: 25
max_ack_delay = 25

# Active connection ID limit (RFC 9000 §5.1.1)
# Default: 2
active_connection_id_limit = 2

# Enable peer certificate verification
# Default: true
verify_peer = true

# CA certificate file for peer verification
# Default: None
# ca_cert_file = "/path/to/ca.crt"

# CA certificate directory for peer verification
# Default: None
# ca_cert_dir = "/path/to/ca/dir"

# Session ticket for 0-RTT resumption
# Default: None
# session_ticket = "base64-encoded-ticket"

# Log TLS keys for debugging (WARNING: Security risk)
# Default: false
log_keys = false

# Stateless reset token
# Default: None (auto-generated)
# stateless_reset_token = "0123456789abcdef"

# Initial congestion window in packets
# Default: 10
initial_congestion_window_packets = 10

# Enable Hystart++ congestion control
# Default: true
enable_hystart = true

# Maximum pacing rate in bytes per second
# Default: None (unlimited)
# max_pacing_rate = 10000000

# Maximum amplification factor for anti-amplification
# Default: 3
max_amplification_factor = 3

# Enable Path MTU Discovery
# Default: false
discover_pmtu = false

# Enable GREASE for protocol compatibility testing
# Default: true
grease = true

# Disable destination connection ID reuse
# Default: false
disable_dcid_reuse = false

# Maximum DATAGRAM receive queue length
# Default: 1000
dgram_recv_max_queue_len = 1000

# Maximum DATAGRAM send queue length
# Default: 1000
dgram_send_max_queue_len = 1000

# ----------------------------------------------------------------------------
# Network I/O Configuration
# ----------------------------------------------------------------------------
[global.netio]
# Number of network I/O worker threads
# Default: Number of CPU cores
# workers = 8

# Enable SO_REUSEPORT for load distribution
# Default: true
reuse_port = true

# Pin worker threads to specific CPU cores
# Default: true
pin_to_cpu = true

# io_uring submission queue entries per worker (must be power of 2)
# Default: 2048
uring_entries = 2048

# Kernel receive buffer size (SO_RCVBUF)
# Larger buffers reduce packet loss under burst traffic
# Default: None (system default)
# socket_recv_buffer_size = 2097152

# Kernel send buffer size (SO_SNDBUF)
# Default: None (system default)
# socket_send_buffer_size = 2097152

# Enable UDP GRO (Generic Receive Offload)
# Linux 5.0+ only, gracefully degrades on other platforms
# Default: true
enable_gro = true

# Enable UDP GSO (Generic Segmentation Offload)
# Linux 4.18+ only, gracefully degrades on other platforms
# Default: true
enable_gso = true

# Maximum size for coalesced UDP packets
# Default: 1400
max_coalesced_size = 1400

[global.netio.buffer_pool]
# Maximum buffers per worker (isolated pools, no sharing)
# Default: System-calculated
# max_buffers_per_worker = 2048

# Datagram size for buffer trimming
# Default: 1350
datagram_size = 1350

# ----------------------------------------------------------------------------
# Channel Capacity Configuration
# ----------------------------------------------------------------------------
[global.channels]
# Worker egress channel capacity (app → worker)
# All app tasks share this channel per worker
# Default: 2048
worker_egress_capacity = 2048

# Connection ingress channel capacity (worker → app)
# Per-connection event stream buffer
# Default: 1024
connection_ingress_capacity = 1024

# Stream ingress channel capacity (worker → app)
# Per-stream data buffer
# Default: 256
stream_ingress_capacity = 256

# Stream egress channel capacity (app → worker)
# Per-stream write command buffer
# Default: 256
stream_egress_capacity = 256

# ----------------------------------------------------------------------------
# Telemetry Configuration
# ----------------------------------------------------------------------------
[global.telemetry]
# Enable telemetry system
# Default: true
enabled = true

# Metrics export interval in seconds
# Default: 60
export_interval_seconds = 60

# OpenTelemetry collector endpoint
# Default: "http://localhost:4317"
otlp_endpoint = "http://localhost:4317"

# Service name for telemetry
# Default: "quicd"
service_name = "quicd"

# Enable detailed per-connection metrics
# Warning: High cardinality, may impact performance
# Default: false
enable_per_connection_metrics = false

# ----------------------------------------------------------------------------
# Network I/O Configuration
# ----------------------------------------------------------------------------
[global.netio]
# Number of network I/O worker threads
# Default: Number of CPU cores
workers = 8

# Enable SO_REUSEPORT for load distribution
reuse_port = true

# Pin worker threads to specific CPU cores
pin_to_cpu = true

# io_uring submission queue entries per worker (must be power of 2)
uring_entries = 2048

# Kernel receive buffer size (SO_RCVBUF)
# Larger buffers reduce packet loss under burst traffic
# socket_recv_buffer_size = 2097152  # 2 MB

# Kernel send buffer size (SO_SNDBUF)
# socket_send_buffer_size = 2097152  # 2 MB

# Enable UDP GRO (Generic Receive Offload)
# Linux 5.0+ only, gracefully degrades on other platforms
enable_gro = true

# Enable UDP GSO (Generic Segmentation Offload)
# Linux 4.18+ only, gracefully degrades on other platforms
enable_gso = true

# Maximum size for coalesced UDP packets
max_coalesced_size = 1400

[global.netio.buffer_pool]
# Maximum buffers per worker (isolated pools, no sharing)
max_buffers_per_worker = 2048

# Datagram size for buffer trimming
datagram_size = 1350

# ----------------------------------------------------------------------------
# Channel Capacity Configuration
# ----------------------------------------------------------------------------
[global.channels]
# Worker egress channel capacity (app → worker)
# All app tasks share this channel per worker
worker_egress_capacity = 2048

# Connection ingress channel capacity (worker → app)
# Per-connection event stream buffer
connection_ingress_capacity = 1024

# Stream ingress channel capacity (worker → app)
# Per-stream data buffer
stream_ingress_capacity = 256

# Stream egress channel capacity (app → worker)
# Per-stream write command buffer
stream_egress_capacity = 256

# ----------------------------------------------------------------------------
# Telemetry Configuration
# ----------------------------------------------------------------------------
[global.telemetry]
# Enable telemetry system
enabled = true

# Metrics export interval in seconds
export_interval_seconds = 60

# OpenTelemetry collector endpoint
otlp_endpoint = "http://localhost:4317"

# Service name for telemetry
service_name = "quicd"

# Enable detailed per-connection metrics
# Warning: High cardinality, may impact performance
enable_per_connection_metrics = false

# ============================================================================
# APPLICATION CONFIGURATIONS
# ============================================================================
# Define application protocols and their ALPN mappings.
# Each application has its own configuration schema.

# ----------------------------------------------------------------------------
# HTTP/3 Application
# ----------------------------------------------------------------------------
[[applications]]
# ALPN identifier (used during QUIC handshake)
alpn = "h3"

# Application type: "http3" or "plugin"
type = "http3"

# Enable this application
# Default: true
enabled = true

# Custom request handler configuration (optional)
# Default: None
# [applications.handler]
# custom_field = "value"

# ----------------------------------------------------------------------------
# HTTP/3 (Draft 29) - For backwards compatibility
# ----------------------------------------------------------------------------
[[applications]]
alpn = "h3-29"
type = "http3"
enabled = true
# Inherits same defaults as h3, override as needed

# ----------------------------------------------------------------------------
# Plugin Protocol Example
# ----------------------------------------------------------------------------
# Load a custom protocol from a dynamic library (.so/.dylib/.dll)
# The plugin must be compiled with quicd-x and export the factory using
# the export_quic_app! macro. See PLUGIN_DEVELOPMENT.md for details.
#
# [[applications]]
# alpn = "my-custom-proto"
# type = "plugin"
# [applications.config]
# library_path = "/path/to/libmy_custom_proto.so"
#
# # You can load multiple plugins
# [[applications]]
# alpn = "echo"
# type = "plugin"
# [applications.config]
# library_path = "/usr/local/lib/quicd/libecho_protocol.so"
#
# # ABI Compatibility Requirements:
# - Plugin must be compiled with the same Rust compiler version as the server
# - Plugin must use the same quicd-x dependency version
# - Plugin must be compiled for the same target architecture

# ============================================================================
# CONFIGURATION PRESETS
# ============================================================================
#
# Instead of manually configuring every field, you can use presets:
#
# High Throughput (large buffers, high concurrency):
#   - max_concurrent_streams = 1000
#   - stream_buffer_max_size = 8 MB
#   - worker_egress_capacity = 8192
#
# Low Memory (minimal buffers, tight limits):
#   - max_concurrent_streams = 10
#   - stream_buffer_max_size = 64 KB
#   - worker_egress_capacity = 512
#
# Low Latency (small buffers, aggressive backpressure):
#   - stream_buffer_max_size = 256 KB
#   - idle_check_interval = 1s
#
# CDN/Edge (balanced, with server push):
#   - max_concurrent_streams = 200
#   - enable_server_push = true
#   - qpack_max_table_capacity = 8 KB
#
# Apply presets by starting with a template or manually adjusting values.
